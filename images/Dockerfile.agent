# Dockerfile.agent - Cross-compile bouvet-agent inside Docker
# This allows building Linux musl binaries from macOS without cross-toolchains

FROM rust:slim-bookworm AS builder

# Install musl target and required tools
# Note: For cross-arch builds (ARM64 on x86 or vice versa), Docker's QEMU
# emulation handles this transparently when using --platform flag
RUN apt-get update && apt-get install -y --no-install-recommends \
    musl-tools \
    musl-dev \
    && rm -rf /var/lib/apt/lists/*

# Add the musl target for the current architecture
ARG RUST_TARGET=aarch64-unknown-linux-musl
RUN rustup target add ${RUST_TARGET}

# Create workspace
WORKDIR /build

# Copy Cargo files first for better layer caching
COPY Cargo.toml ./

# Create dummy crate structure for dependency caching
RUN mkdir -p crates/bouvet-agent/src crates/bouvet-core/src crates/bouvet-vm/src crates/bouvet-mcp/src && \
    echo "fn main() {}" > crates/bouvet-agent/src/main.rs && \
    echo "" > crates/bouvet-core/src/lib.rs && \
    echo "" > crates/bouvet-vm/src/lib.rs && \
    echo "" > crates/bouvet-mcp/src/lib.rs

# Copy all Cargo.toml files
COPY crates/bouvet-agent/Cargo.toml crates/bouvet-agent/
COPY crates/bouvet-core/Cargo.toml crates/bouvet-core/
COPY crates/bouvet-vm/Cargo.toml crates/bouvet-vm/
COPY crates/bouvet-mcp/Cargo.toml crates/bouvet-mcp/

# Build dependencies only (cached layer)
RUN cargo build -p bouvet-agent --release --target ${RUST_TARGET} 2>/dev/null || true

# Now copy actual source code
COPY crates ./crates

# FORCE TIMESTAMP UPDATE: Touch source files to ensure they are newer than the dummy files
# This prevents Cargo from skipping the build if host mtime < dummy file mtime
RUN find crates -name "*.rs" -exec touch {} \;

# Build the agent for real
RUN cargo build -p bouvet-agent --release --target ${RUST_TARGET}

# Copy the binary to a known location
RUN cp /build/target/${RUST_TARGET}/release/bouvet-agent /bouvet-agent

# Output stage - just the binary
FROM scratch
COPY --from=builder /bouvet-agent /bouvet-agent
